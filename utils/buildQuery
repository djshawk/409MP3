function safeParseJSON(value, fallback) {
  if (value == null) return fallback;
  try { return JSON.parse(value); } catch { return fallback; }
}

function applyQueryParams(model, req, defaultLimit) {
  const where   = safeParseJSON(req.query.where,   {});
  const selectQ = safeParseJSON(req.query.select,  safeParseJSON(req.query.filter, null)); 
  const sort    = safeParseJSON(req.query.sort,    null);
  const skip    = req.query.skip  ? Number(req.query.skip)  : undefined;
  const limitQ  = req.query.limit ? Number(req.query.limit) : undefined;
  const count   = String(req.query.count || 'false').toLowerCase() === 'true';

  let q = model.find(where);
  if (sort)    q = q.sort(sort);
  if (selectQ) q = q.select(selectQ);
  if (typeof skip === 'number') q = q.skip(skip);

  if (!count) {
    const limitFinal = typeof limitQ === 'number'
      ? limitQ
      : (typeof defaultLimit === 'number' ? defaultLimit : undefined);
    if (typeof limitFinal === 'number') q = q.limit(limitFinal);
  }
  return { query: q, count };
}

function getQueryFilter(q) {
  if (q && typeof q.getFilter === 'function') return q.getFilter(); 
  if (q && typeof q.getQuery  === 'function') return q.getQuery();  
  return {};
}

module.exports = { applyQueryParams, safeParseJSON, getQueryFilter };
