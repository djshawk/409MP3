function safeParseJSON(v, fb) {
  if (v == null) return fb;
  try { return JSON.parse(v); } catch { return fb; }
}

function applyQueryParams(m, r, dLim) {
  const w   = safeParseJSON(r.query.where, {});
  const sQ  = safeParseJSON(r.query.select, safeParseJSON(r.query.filter, null));
  const so  = safeParseJSON(r.query.sort, null);
  const sk  = r.query.skip  ? Number(r.query.skip)  : undefined;
  const lim = r.query.limit ? Number(r.query.limit) : undefined;
  const cnt = String(r.query.count || 'false').toLowerCase() === 'true';

  let q = m.find(w);
  if (so) q = q.sort(so);
  if (sQ) q = q.select(sQ);
  if (typeof sk === 'number') q = q.skip(sk);

  if (!cnt) {
    const lf = typeof lim === 'number' ? lim : (typeof dLim === 'number' ? dLim : undefined);
    if (typeof lf === 'number') q = q.limit(lf);
  }
  return { query: q, count: cnt };
}

function getQueryFilter(q) {
  if (q && typeof q.getFilter === 'function') return q.getFilter();
  if (q && typeof q.getQuery  === 'function') return q.getQuery();
  return {};
}

module.exports = { applyQueryParams, safeParseJSON, getQueryFilter };
